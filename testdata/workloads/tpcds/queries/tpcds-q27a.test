====
---- QUERY: TPCDS-Q27a
with results as
 (select i_item_id,
         s_state,
         0 as g_state,
         ss_quantity agg1,
         ss_list_price agg2,
         ss_coupon_amt agg3,
         ss_sales_price agg4
  from store_sales,
       customer_demographics,
       date_dim,
       store,
       item
  where ss_sold_date_sk = d_date_sk and
        ss_item_sk = i_item_sk and
         ss_store_sk = s_store_sk and
        ss_cdemo_sk = cd_demo_sk and
        cd_gender = 'M' and
        cd_marital_status = 'S' and
        cd_education_status = 'College' and
        d_year = 2002 and
        s_state in ('TN','TN', 'TN', 'TN', 'TN', 'TN'))
select i_item_id,
       s_state,
       g_state,
       agg1,
       agg2,
       agg3,
       agg4
from (select i_item_id,
             s_state,
             0 as g_state,
             avg(agg1) agg1,
             avg(agg2) agg2,
             avg(agg3) agg3,
             avg(agg4) agg4 from results
      group by i_item_id,
               s_state
      union all
      select i_item_id,
             NULL AS s_state,
             1 AS g_state,
             avg(agg1) agg1,
             avg(agg2) agg2,
             avg(agg3) agg3,
             avg(agg4) agg4 from results
      group by i_item_id
      union all
      select NULL AS i_item_id,
             NULL as s_state,
             1 as g_state,
             avg(agg1) agg1,
             avg(agg2) agg2,
             avg(agg3) agg3,
             avg(agg4) agg4 from results) foo
order by i_item_id, s_state
limit 100;
---- RESULTS
'AAAAAAAAAAABAAAA','TN',0,46,114.72,0.00,32.12
'AAAAAAAAAAABAAAA','NULL',1,46,114.72,0.00,32.12
'AAAAAAAAAAAEAAAA','TN',0,100,77.97,0.00,57.69
'AAAAAAAAAAAEAAAA','NULL',1,100,77.97,0.00,57.69
'AAAAAAAAAABAAAAA','TN',0,6,48.89,13.61,2.44
'AAAAAAAAAABAAAAA','NULL',1,6,48.89,13.61,2.44
'AAAAAAAAAACAAAAA','TN',0,62,32.21,0.00,5.50
'AAAAAAAAAACAAAAA','NULL',1,62,32.21,0.00,5.50
'AAAAAAAAAACDAAAA','TN',0,97,161.78,0.00,55.00
'AAAAAAAAAACDAAAA','NULL',1,97,161.78,0.00,55.00
'AAAAAAAAAADBAAAA','TN',0,28,136.01,575.76,73.44
'AAAAAAAAAADBAAAA','NULL',1,28,136.01,575.76,73.44
'AAAAAAAAAADCAAAA','TN',0,64,116.14,0.00,108.01
'AAAAAAAAAADCAAAA','NULL',1,64,116.14,0.00,108.01
'AAAAAAAAAAEBAAAA','TN',0,9,5.43,0.00,5.21
'AAAAAAAAAAEBAAAA','NULL',1,9,5.43,0.00,5.21
'AAAAAAAAAAEDAAAA','TN',0,45.5,87.63,0.00,51.84
'AAAAAAAAAAEDAAAA','NULL',1,45.5,87.63,0.00,51.84
'AAAAAAAAAAGBAAAA','TN',0,29,101.94,0.00,100.92
'AAAAAAAAAAGBAAAA','NULL',1,29,101.94,0.00,100.92
'AAAAAAAAAAGCAAAA','TN',0,97,65.27,0.00,21.53
'AAAAAAAAAAGCAAAA','NULL',1,97,65.27,0.00,21.53
'AAAAAAAAAAGEAAAA','TN',0,55,73.87,0.00,71.00
'AAAAAAAAAAGEAAAA','NULL',1,55,73.87,0.00,71.00
'AAAAAAAAAAHAAAAA','TN',0,20,134.30,0.00,119.52
'AAAAAAAAAAHAAAAA','NULL',1,20,134.30,0.00,119.52
'AAAAAAAAAAHBAAAA','TN',0,97,7.40,0.00,6.73
'AAAAAAAAAAHBAAAA','NULL',1,97,7.40,0.00,6.73
'AAAAAAAAAAHDAAAA','TN',0,69,5.62,0.00,0.33
'AAAAAAAAAAHDAAAA','NULL',1,69,5.62,0.00,0.33
'AAAAAAAAAAIAAAAA','TN',0,87,106.98,0.00,27.81
'AAAAAAAAAAIAAAAA','NULL',1,87,106.98,0.00,27.81
'AAAAAAAAAAKBAAAA','TN',0,84.5,66.17,847.83,57.38
'AAAAAAAAAAKBAAAA','NULL',1,84.5,66.17,847.83,57.38
'AAAAAAAAAALAAAAA','TN',0,6,32.28,0.00,7.42
'AAAAAAAAAALAAAAA','NULL',1,6,32.28,0.00,7.42
'AAAAAAAAAALCAAAA','TN',0,98,34.31,55.30,1.71
'AAAAAAAAAALCAAAA','NULL',1,98,34.31,55.30,1.71
'AAAAAAAAAALDAAAA','TN',0,59,129.47,713.90,22.00
'AAAAAAAAAALDAAAA','NULL',1,59,129.47,713.90,22.00
'AAAAAAAAAANAAAAA','TN',0,74,60.87,0.00,13.20
'AAAAAAAAAANAAAAA','NULL',1,74,60.87,0.00,13.20
'AAAAAAAAAANBAAAA','TN',0,96,130.79,1864.51,129.48
'AAAAAAAAAANBAAAA','NULL',1,96,130.79,1864.51,129.48
'AAAAAAAAAAOAAAAA','TN',0,85,130.34,0.00,122.51
'AAAAAAAAAAOAAAAA','NULL',1,85,130.34,0.00,122.51
'AAAAAAAAAAOCAAAA','TN',0,14,64.57,0.00,33.97
'AAAAAAAAAAOCAAAA','NULL',1,14,64.57,0.00,33.97
'AAAAAAAAAAODAAAA','TN',0,84,30.50,0.00,28.97
'AAAAAAAAAAODAAAA','NULL',1,84,30.50,0.00,28.97
'AAAAAAAAAAPBAAAA','TN',0,45,118.89,2380.59,84.71
'AAAAAAAAAAPBAAAA','NULL',1,45,118.89,2380.59,84.71
'AAAAAAAAABAAAAAA','TN',0,97,124.75,0.00,74.85
'AAAAAAAAABAAAAAA','NULL',1,97,124.75,0.00,74.85
'AAAAAAAAABABAAAA','TN',0,31,29.98,17.09,27.58
'AAAAAAAAABABAAAA','NULL',1,31,29.98,17.09,27.58
'AAAAAAAAABAEAAAA','TN',0,34,17.21,0.00,13.42
'AAAAAAAAABAEAAAA','NULL',1,34,17.21,0.00,13.42
'AAAAAAAAABCBAAAA','TN',0,38,131.37,0.00,52.32
'AAAAAAAAABCBAAAA','NULL',1,38,131.37,0.00,52.32
'AAAAAAAAABDAAAAA','TN',0,31.5,68.34,0.00,63.27
'AAAAAAAAABDAAAAA','NULL',1,31.5,68.34,0.00,63.27
'AAAAAAAAABDBAAAA','TN',0,56,103.85,1624.17,59.19
'AAAAAAAAABDBAAAA','NULL',1,56,103.85,1624.17,59.19
'AAAAAAAAABDDAAAA','TN',0,67.33333333333333,119.42,23.18,38.72
'AAAAAAAAABDDAAAA','NULL',1,67.33333333333333,119.42,23.18,38.72
'AAAAAAAAABDEAAAA','TN',0,61,85.95,2282.36,44.60
'AAAAAAAAABDEAAAA','NULL',1,61,85.95,2282.36,44.60
'AAAAAAAAABEDAAAA','TN',0,61,85.14,0.00,50.23
'AAAAAAAAABEDAAAA','NULL',1,61,85.14,0.00,50.23
'AAAAAAAAABFBAAAA','TN',0,31,23.55,0.00,13.65
'AAAAAAAAABFBAAAA','NULL',1,31,23.55,0.00,13.65
'AAAAAAAAABFCAAAA','TN',0,83,15.50,0.00,0.00
'AAAAAAAAABFCAAAA','NULL',1,83,15.50,0.00,0.00
'AAAAAAAAABGAAAAA','TN',0,64,35.08,0.00,3.15
'AAAAAAAAABGAAAAA','NULL',1,64,35.08,0.00,3.15
'AAAAAAAAABGBAAAA','TN',0,40,25.07,0.00,16.04
'AAAAAAAAABGBAAAA','NULL',1,40,25.07,0.00,16.04
'AAAAAAAAABGEAAAA','TN',0,39.5,56.76,14.25,36.00
'AAAAAAAAABGEAAAA','NULL',1,39.5,56.76,14.25,36.00
'AAAAAAAAABHAAAAA','TN',0,93,74.80,0.00,21.69
'AAAAAAAAABHAAAAA','NULL',1,93,74.80,0.00,21.69
'AAAAAAAAABHCAAAA','TN',0,31.5,79.83,181.38,61.93
'AAAAAAAAABHCAAAA','NULL',1,31.5,79.83,181.38,61.93
'AAAAAAAAABIBAAAA','TN',0,48,170.89,0.00,140.12
'AAAAAAAAABIBAAAA','NULL',1,48,170.89,0.00,140.12
'AAAAAAAAABJAAAAA','TN',0,46.5,82.32,0.00,44.98
'AAAAAAAAABJAAAAA','NULL',1,46.5,82.32,0.00,44.98
'AAAAAAAAABJBAAAA','TN',0,76,12.40,0.00,3.96
'AAAAAAAAABJBAAAA','NULL',1,76,12.40,0.00,3.96
'AAAAAAAAABJDAAAA','TN',0,34,118.50,0.00,61.20
'AAAAAAAAABJDAAAA','NULL',1,34,118.50,0.00,61.20
'AAAAAAAAABKAAAAA','TN',0,65,8.77,0.00,5.18
'AAAAAAAAABKAAAAA','NULL',1,65,8.77,0.00,5.18
'AAAAAAAAABKCAAAA','TN',0,26,51.57,0.00,41.25
'AAAAAAAAABKCAAAA','NULL',1,26,51.57,0.00,41.25
'AAAAAAAAABLBAAAA','TN',0,61.5,149.12,0.00,82.54
'AAAAAAAAABLBAAAA','NULL',1,61.5,149.12,0.00,82.54
'AAAAAAAAABMAAAAA','TN',0,14,109.97,0.00,10.99
'AAAAAAAAABMAAAAA','NULL',1,14,109.97,0.00,10.99
---- TYPES
STRING,STRING,TINYINT,DOUBLE,DECIMAL,DECIMAL,DECIMAL
====